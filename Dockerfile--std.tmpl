ARG PG_VERSION
ARG PYTHON_VERSION 

FROM postgres:${PG_VERSION}-alpine as base1

FROM base1 as base2_with_python-2
RUN apk add --no-cache curl python2 python2-dev build-base musl-dev linux-headers py-virtualenv py-pip

FROM base1 as base2_with_python-3
RUN apk add --no-cache curl python3 python3-dev build-base musl-dev linux-headers py-virtualenv

FROM base2_with_python-${PYTHON_VERSION} as final

ENV LANG=C.UTF-8

ADD . /pg/testgres
WORKDIR /pg/testgres
RUN chown -R postgres:postgres /pg

USER postgres
ENTRYPOINT PYTHON_VERSION="${PYTHON_VERSION}" bash run_tests.sh
